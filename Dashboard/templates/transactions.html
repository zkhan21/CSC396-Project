{% extends "base.html" %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/transactions.css') }}">
{% endblock %}
{% block content %}
    <h1>All Transactions</h1>
    
    <!-- Summary Section -->
    <div class="summary">
        <h2>Total Spent: ${{ "%.2f"|format(summary.total) }}</h2>
        <canvas id="categoryChart"></canvas>
        <canvas id="spendingTrendChart"></canvas>
    </div>

    <!-- Filters Section -->
    <div class="filters">
        <label for="filter-date">Filter by Date:</label>
        <input type="date" id="filter-date" name="filter_date">
        
        <label for="filter-category">Filter by Category:</label>
        <select id="filter-category" name="filter_category">
            <option value="">All Categories</option>
            {% for category in summary.categories %}
            <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
        </select>
        
        <button onclick="applyFilters()">Apply Filters</button>
    </div>

    <!-- Add Transaction and Delete Transaction(s) Buttons -->
    <div class="action-buttons">
        <a href="{{ url_for('main.add_transaction') }}" class="btn">Add Transaction</a>
        <button type="submit" form="deleteForm" class="btn btn-danger">Delete Transaction(s)</button>
    </div>

    <!-- Bulk Delete Form -->
    <form id="deleteForm" method="POST" action="{{ url_for('main.delete_transactions') }}">
        <table>
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td><input type="checkbox" name="transaction_ids" value="{{ t._id }}"></td>
                    <td>{% if t.date is string %}{{ t.date }}{% else %}{{ t.date.strftime('%m-%d-%Y') }}{% endif %}</td>
                    <td>{{ t.category }}</td>
                    <td>{{ t.description|capitalize }}</td>
                    <td>${{ "%.2f"|format(t.amount) }}</td>
                    <td class="table-actions">
                        <a href="{{ url_for('main.edit_transaction', transaction_id=t._id) }}" class="btn btn-small">Edit</a>
                        <a href="{{ url_for('main.delete_transaction', transaction_id=t._id) }}" class="btn btn-small btn-secondary">Delete</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6">No transactions found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </form>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let categories = JSON.parse('{{ summary.categories|default([])|tojson|safe }}');
            let amounts = JSON.parse('{{ summary.amounts|default([])|tojson|safe }}');
            let dates = JSON.parse('{{ summary.dates|default([])|tojson|safe }}');
            let trendAmounts = JSON.parse('{{ summary.trend_amounts|default([])|tojson|safe }}');
            let totalSpent = amounts.reduce((acc, amount) => acc + amount, 0);
    
            // Ensure the colors align with categories correctly
            const categoryData = {
                labels: categories,
                datasets: [{
                    label: 'Spending by Category',
                    data: amounts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)', // Red
                        'rgba(54, 162, 235, 0.2)', // Blue
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ].slice(0, categories.length),
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ].slice(0, categories.length),
                    borderWidth: 1
                }]
            };
    
            const trendData = {
                labels: dates,
                datasets: [{
                    label: 'Spending Trend',
                    data: trendAmounts,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    fill: false
                }]
            };
    
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'pie',
                data: categoryData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Spending by Category'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    let index = tooltipItem.dataIndex;
                                    let category = categoryData.labels[index];
                                    let amount = categoryData.datasets[0].data[index];
                                    let percentage = ((amount / totalSpent) * 100).toFixed(2);
                                    return `${category}: ${percentage}%\nSpending by Category:\n$${amount.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
    
            const trendCtx = document.getElementById('spendingTrendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: trendData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Spending Trend Over Time'
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}